<!DOCTYPE html>
<html>
  <head>
    <title>Messages</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        background-color: #f8f9fa;
      }

      .container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }

      h1 {
        text-align: center;
      }

      .form-control {
        margin-bottom: 1rem;
      }

      .btn-primary {
        width: 100%;
      }

      .table-container {
        overflow-x: auto;
        /* max-width: 100%; */
      }

      .table {
        width: 100%;
      }

      .table th,
      .table td {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        max-width: 150px; /* Imposta la larghezza massima desiderata per ciascuna cella */
      }

      .list-group-item {
        background-color: #fff;
        margin-bottom: 10px;
      }
      .label-small {
        font-size: 0.7em;
        color: #888;
        margin-bottom: 1px;
        visibility: hidden;
      }
    </style>
  </head>
  <body>
    <!-- Navigation bar -->
    <div id="nav-placeholder"></div>

    <!-- Modal -->
    <div
      class="modal fade"
      id="squealModal"
      tabindex="-1"
      aria-labelledby="squealModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="squealModalLabel">Squeal detail</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body text-center">
            <p id="squealModalAuthor"></p>
            <p id="squealModalReceivers"></p>
            <p id="squealModalContent"></p>
            <p id="squealModalImpression"></p>
            <p id="squealModalDate"></p>
          </div>
        </div>
      </div>
    </div>

    <div class="container my-4">
      <h1 class="mt-4 mb-4">Messages</h1>

      <div class="row">
        <div class="col-md-3">
          <label for="authorFilter" class="label-small">Author</label>
          <input
            type="text"
            class="form-control"
            id="authorFilter"
            placeholder="Filter by Author"
          />
        </div>
        <div class="col-md-3">
          <label for="contentTypeFilter" class="label-small"
            >Content Type</label
          >
          <select class="form-select" id="contentTypeFilter">
            <option value="">Filter by Content Type</option>
            <option value="text">Text</option>
            <option value="image">Image</option>
            <option value="video">Video</option>
            <option value="geolocalization">Geolocalization</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="dateFilter" class="label-small">Date</label>
          <input type="date" class="form-control" id="dateFilter" />
        </div>
        <div class="col-md-3">
          <label for="squealType" class="label-small">Public Squeal</label>
          <select class="form-select" id="squealType">
            <option value="">Filter by Public Squeal</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary mb-4" id="fetchMessagesButton">
        Fetch Messages
      </button>

      <div class="table-container">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Author</th>
              <th>Receiver</th>
              <th>Content</th>
              <th>Content Type</th>
              <th>Impression</th>
              <th>Date</th>
              <th>More</th>
            </tr>
          </thead>
          <tbody id="messageList">
            <!-- Messages will be listed here -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      function isUserLoggedIn() {
        // Return true if logged in, false if not.
        var token = sessionStorage.getItem("token");

        return !(token === null);
      }

      $(function () {
        $("#nav-placeholder").load("navBar.html");
      });
      let messagesData = []; // To store the message data

      // Function to fetch message data
      function fetchMessageData() {
        $.ajax({
          url: "http://localhost:3500/api/squeals",
          method: "GET",
          beforeSend: function (xhr) {
            xhr.setRequestHeader(
              "Authorization",
              "Bearer " + sessionStorage.getItem("token")
            );
          },
          success: function (data) {
            messagesData = data;
            populateMessageList(messagesData);
          },
          error: function (xhr, status, error) {
            console.log(status);
            console.log(error);
            alert("Impossibile caricare i messaggi.");
          },
        });
      }

      // Function to populate the message list
      function populateMessageList(messages) {
        const authorFilter = $("#authorFilter").val().toLowerCase();
        const contentTypeFilter = $("#contentTypeFilter").val();
        const dateFilter = new Date(
          $("#dateFilter").val()
        ).toLocaleDateString();
        const squealType = $("#squealType").val().toLowerCase();

        const messageList = $("#messageList");
        messageList.empty();

        messages.forEach(function (message) {
          if (
            (authorFilter === "" ||
              message.author.toLowerCase().includes(authorFilter)) &&
            (contentTypeFilter === "" ||
              message.contentType === contentTypeFilter) &&
            ($("#dateFilter").val() === "" ||
              new Date(message.createdAt).toLocaleDateString() ===
                dateFilter) &&
            (squealType === "" ||
              message.publicSqueal?.toString() === squealType)
          ) {
            messageList.append(
              "<tr><td>" +
                message.author.username +
                "</td><td>" +
                (message.publicSqueal
                  ? "Public"
                  : message.receivers?.map((item) => {
                      return item.groupType === "Channel"
                        ? "§" + item.group?.name
                        : "#" + item.group?.name;
                    })) +
                "</td><td>" +
                message.content +
                "</td><td>" +
                message.contentType +
                "</td><td>" +
                message.impression +
                "</td><td>" +
                new Date(message.createdAt).toLocaleDateString() +
                "</td><td>" +
                `<button class='btn btn-primary' onclick='actionButtonClick("${message._id}")'>Details</button>` +
                "</td></tr>"
            );
          }
        });
      }
      $(document).ready(function () {
        if (!isUserLoggedIn()) {
          // Il token non è presente nel sessionStorage, redirect alla pagina di login
          window.location.href = "./";
        }
        // Add event listeners to the filters
        $("#authorFilter, #contentTypeFilter, #dateFilter, #squealType").on(
          "input",
          function () {
            populateMessageList(messagesData);
          }
        );

        // Add an event listener to the "Fetch Messages" button
        $("#fetchMessagesButton").click(function () {
          fetchMessageData();
        });
        // Listener for labels visibility
        $("#authorFilter").change(function () {
          const label = $('label[for="authorFilter"]');
          label.css("visibility", this.value !== "" ? "visible" : "hidden");
        });

        $("#contentTypeFilter").change(function () {
          const label = $('label[for="contentTypeFilter"]');
          label.css("visibility", this.value !== "" ? "visible" : "hidden");
        });

        $("#dateFilter").change(function () {
          const label = $('label[for="dateFilter"]');
          label.css("visibility", this.value !== "" ? "visible" : "hidden");
        });

        $("#squealType").on("input", function () {
          const label = $('label[for="squealType"]');
          label.css(
            "visibility",
            this.value.trim() !== "" ? "visible" : "hidden"
          );
        });
      });

      function actionButtonClick(squealId) {
        // Popola il contenuto del modal con le informazioni dell'utente
        const squeal = messagesData.find((u) => u._id === squealId);

        const receivers = squeal.publicSqueal
          ? "Public"
          : squeal.receivers?.map((item) => {
              return item.groupType === "Channel"
                ? "§" + item.group?.name
                : "#" + item.group?.name;
            });

        // Popola il contenuto del modal con le informazioni dell'utente
        $("#squealModalAuthor").text(
          `Author: ${squeal.author.username}, ${squeal.author.firstname} ${squeal.author.surname}`
        );
        $("#squealModalReceivers").text(`Receivers: ${receivers}`);
        $("#squealModalContent").text(`Content: ${squeal.content}`);
        $("#squealModalImpression").text(`Impression: ${squeal.impression}`);
        $("#squealModalDate").text(
          `Date: ${new Date(squeal.createdAt).toLocaleDateString()} `
        );

        $("#squealModalLabel").data("squeal", squeal);

        var myModal = new bootstrap.Modal(
          document.getElementById("squealModal")
        );
        myModal.show();
      }
    </script>
  </body>
</html>
